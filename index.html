<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼¢å ¡ç¬¨æ±è¥¿</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #FFF5E6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ‹‰å‹•é‡æ•´ */
        }

        h1 {
            color: #8B4513;
            margin: 10px 0;
            font-size: 24px;
        }

        #game-container {
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-radius: 12px;
            overflow: hidden;
            border: 4px solid #D2691E;
            background-color: #fff;
        }

        canvas {
            display: block;
            cursor: crosshair;
        }

        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            pointer-events: none;
        }

        .score-board {
            font-size: 20px;
            font-weight: bold;
            color: #8B4513;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 12px;
            border-radius: 20px;
        }

        #message {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #d35400;
            text-shadow: 2px 2px 0px #fff;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        .controls {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
            text-align: center;
            padding: 0 20px;
        }
    </style>
</head>
<body>

    <h1>ğŸ§‹ Qå½ˆçç æŠ•ç±ƒ</h1>
    
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="ui-layer">
            <div class="score-board">å¾—åˆ†: <span id="score">0</span></div>
        </div>
        <div id="message">å¥½çƒï¼</div>
    </div>

    <div class="controls">
        <p>æ‹–æ›³ç„æº– (æ”¯æ´æ‰‹æ©Ÿè§¸æ§) â” æ”¾é–‹å°„æ“Š</p>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const msgEl = document.getElementById('message');

        // --- éŸ¿æ‡‰å¼è¨­ç½® (è§£æ±ºæ¯å­ä¸è¦‹çš„å•é¡Œ) ---
        function resizeCanvas() {
            // é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…åœ¨é›»è…¦ä¸Šå¤ªå¯¬ï¼Œä½†åœ¨æ‰‹æ©Ÿä¸Šå¡«æ»¿
            let w = window.innerWidth * 0.95;
            let h = window.innerHeight * 0.6;
            
            if (w > 800) w = 800;
            if (h > 600) h = 600;

            canvas.width = w;
            canvas.height = h;

            // é‡è¨­ç‰©ä»¶ä½ç½®
            resetPositions();
        }

        // --- éŠæˆ²è®Šæ•¸ ---
        let score = 0;
        
        // è¼¸å…¥ç‹€æ…‹
        let isDragging = false;
        let dragStartX, dragStartY;
        let inputX, inputY; // æ•´åˆæ»‘é¼ èˆ‡è§¸æ§åº§æ¨™

        // ç‰©ç†åƒæ•¸ (èª¿æ•´å½ˆè·³æ„Ÿ)
        const gravity = 0.8;       // é‡åŠ›ç¨å¾®åŠ å¤§
        const bounce = 0.7;        // å½ˆåŠ›å¢åŠ  (0.5 -> 0.7) è®“å®ƒæ›´Q
        const airFriction = 0.99;  // ç©ºæ°£é˜»åŠ›
        const floorFriction = 0.7; // åœ°é¢æ‘©æ“¦åŠ› (çç æ¿•æ¿•çš„ï¼Œè½åœ°æœƒæ¸›é€Ÿè¼ƒå¿«)
        
        // ç‰©ä»¶å®šç¾©
        let boba = {
            x: 0, y: 0,
            radius: 12,
            vx: 0, vy: 0,
            angle: 0,      // å¢åŠ æ—‹è½‰è§’åº¦
            vAngle: 0,     // è§’é€Ÿåº¦
            isFlying: false,
            color: '#331a00'
        };

        let cup = {
            x: 0, y: 0,
            width: 0, height: 0,
            color: '#E0C097',
            liquidLevel: 0
        };

        let startPos = { x: 0, y: 0 };

        function resetPositions() {
            // æ ¹æ“šç•«å¸ƒå¤§å°å‹•æ…‹è¨ˆç®—ä½ç½®
            startPos.x = canvas.width * 0.15; // å·¦é‚Š 15%
            startPos.y = canvas.height * 0.75; // ä¸‹æ–¹ 75%
            
            // è®“çç å¦‚æœä¸é£›çš„æ™‚å€™å›åˆ°èµ·é»
            if (!boba.isFlying) {
                boba.x = startPos.x;
                boba.y = startPos.y;
                boba.vx = 0;
                boba.vy = 0;
                boba.angle = 0;
            }

            // æ¯å­ä½ç½® (æ°¸é åœ¨å³é‚Š 75% è™•)
            cup.width = canvas.width * 0.15; // æ¯å­å¯¬åº¦éš¨è¢å¹•ç¸®æ”¾
            if (cup.width < 60) cup.width = 60; // æœ€å°å¯¬åº¦
            if (cup.width > 120) cup.width = 120; // æœ€å¤§å¯¬åº¦

            cup.height = cup.width * 1.5;
            cup.x = canvas.width * 0.75; 
            cup.y = canvas.height - cup.height - 20; // æ”¾åœ¨åœ°æ¿ä¸Š
        }

        // --- è¼¸å…¥äº‹ä»¶ç›£è½ (æ»‘é¼  + è§¸æ§) ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // åˆ¤æ–·æ˜¯è§¸æ§é‚„æ˜¯æ»‘é¼ 
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function handleStart(e) {
            if (boba.isFlying) return;
            // e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿç•«é¢æ²å‹•
            
            const pos = getPos(e);
            const dist = Math.hypot(pos.x - boba.x, pos.y - boba.y);
            
            // åˆ¤å®šç¯„åœæ”¾å¯¬ä¸€é»æ–¹ä¾¿æ‰‹æŒ‡é»é¸
            if (dist < 60) {
                isDragging = true;
                dragStartX = boba.x;
                dragStartY = boba.y;
                inputX = pos.x;
                inputY = pos.y;
            }
        }

        function handleMove(e) {
            if (isDragging) {
                // e.preventDefault();
                const pos = getPos(e);
                inputX = pos.x;
                inputY = pos.y;
            }
        }

        function handleEnd(e) {
            if (isDragging) {
                isDragging = false;
                // åŠ›åº¦è¨ˆç®—
                const power = 0.18; // ç¨å¾®å¢åŠ åŠ›åº¦
                boba.vx = (dragStartX - inputX) * power;
                boba.vy = (dragStartY - inputY) * power;
                
                // åŠ å…¥ä¸€é»éš¨æ©Ÿæ—‹è½‰ï¼Œå¢åŠ çœŸå¯¦æ„Ÿ
                boba.vAngle = (Math.random() - 0.5) * 0.5;
                
                boba.isFlying = true;
            }
        }

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);

        // æ‰‹æ©Ÿè§¸æ§æ”¯æ´
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        canvas.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('touchend', handleEnd);

        // --- éŠæˆ²é‚è¼¯ ---
        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            if (boba.isFlying) {
                // é‡åŠ›èˆ‡è§’åº¦æ›´æ–°
                boba.vy += gravity;
                boba.x += boba.vx;
                boba.y += boba.vy;
                boba.angle += boba.vAngle; // æ›´æ–°æ—‹è½‰

                // ç©ºæ°£é˜»åŠ›
                boba.vx *= airFriction;
                boba.vy *= airFriction;

                // --- ç¢°æ’æª¢æ¸¬ï¼šåœ°æ¿ ---
                if (boba.y + boba.radius > canvas.height) {
                    boba.y = canvas.height - boba.radius;
                    
                    // å½ˆè·³
                    boba.vy *= -bounce;
                    
                    // åœ°é¢æ‘©æ“¦ (æ°´å¹³é€Ÿåº¦æ¸›å°‘)
                    boba.vx *= floorFriction;
                    
                    // è½åœ°æ™‚æ ¹æ“šæ°´å¹³é€Ÿåº¦ç”¢ç”Ÿæ»¾å‹•æ•ˆæœ
                    boba.vAngle = boba.vx * 0.15;

                    // åœæ­¢åˆ¤å®šï¼šç•¶è·³å‹•æ¥µå°ä¸”æ°´å¹³é€Ÿåº¦æ¥µå°æ™‚
                    if (Math.abs(boba.vy) < 1.5 && Math.abs(boba.vx) < 0.5) {
                        resetBoba(false);
                    }
                }

                // --- ç¢°æ’æª¢æ¸¬ï¼šç‰†å£ ---
                if (boba.x + boba.radius > canvas.width) {
                    boba.x = canvas.width - boba.radius;
                    boba.vx *= -0.8;
                } else if (boba.x - boba.radius < 0) {
                    boba.x = boba.radius;
                    boba.vx *= -0.8;
                }

                // --- ç¢°æ’æª¢æ¸¬ï¼šæ¯å­ ---
                checkCupCollision();
            }
        }

        function checkCupCollision() {
            // ç°¡æ˜“åˆ¤å®šï¼šé€²å…¥æ¯å£ä¸Šæ–¹å€åŸŸ
            if (boba.vy > 0 && // æ­£åœ¨å¾€ä¸‹æ‰
                boba.x > cup.x && boba.x < cup.x + cup.width && // åœ¨æ¯å­å¯¬åº¦å…§
                boba.y > cup.y && boba.y < cup.y + (cup.height/3)) { // åœ¨æ¯å£é«˜åº¦é™„è¿‘
                
                score++;
                scoreEl.textContent = score;
                showMessage("é€²å•¦ï¼Tasty!");
                
                if(cup.liquidLevel < cup.height - 20) {
                    cup.liquidLevel += 15;
                }
                resetBoba(true);
            }
            
            // æ¯å£ç¢°æ’ (ç°¡å–®ç‰ˆï¼šå¦‚æœæ’åˆ°æ¯å­å·¦å´æˆ–å³å´ä¸”é«˜åº¦ä½æ–¼æ¯å£ï¼Œåå½ˆ)
            if (boba.y > cup.y + 10) {
                 // å·¦å£
                if (boba.x + boba.radius > cup.x && boba.x < cup.x + 20) {
                    boba.vx *= -0.8;
                    boba.x = cup.x - boba.radius;
                }
            }
        }

        function resetBoba(scored) {
            boba.isFlying = false;
            
            setTimeout(() => {
                // ç·©æ…¢æ­¸ä½å‹•ç•«
                let steps = 0;
                const animateReset = () => {
                    boba.x += (startPos.x - boba.x) * 0.2;
                    boba.y += (startPos.y - boba.y) * 0.2;
                    boba.radius = 12; // ç¢ºä¿å¤§å°æ­£ç¢º
                    steps++;
                    if (steps < 20 && Math.abs(boba.x - startPos.x) > 1) {
                        requestAnimationFrame(animateReset);
                    } else {
                        boba.x = startPos.x;
                        boba.y = startPos.y;
                        boba.angle = 0;
                        boba.vx = 0;
                        boba.vy = 0;
                    }
                };
                animateReset();
                
            }, scored ? 600 : 200);
        }

        function showMessage(text) {
            msgEl.textContent = text;
            msgEl.style.opacity = 1;
            msgEl.style.transform = "translate(-50%, -50%) scale(1.2)";
            setTimeout(() => {
                msgEl.style.opacity = 0;
                msgEl.style.transform = "translate(-50%, -50%) scale(1)";
            }, 800);
        }

        // --- ç¹ªåœ– ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. åœ°æ¿
            ctx.fillStyle = '#C7B299';
            ctx.fillRect(0, canvas.height - 10, canvas.width, 10);

            // 2. æ¯å­å¾Œå£
            drawCup(true);

            // 3. ç„æº–ç·š
            if (isDragging && !boba.isFlying) {
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(139, 69, 19, 0.4)';
                ctx.lineWidth = 3;
                ctx.setLineDash([8, 6]);
                ctx.moveTo(boba.x, boba.y);
                ctx.lineTo(inputX, inputY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // é æ¸¬ç·š (åå‘)
                const dx = startPos.x - inputX;
                const dy = startPos.y - inputY;
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(210, 105, 30, 0.8)';
                ctx.lineWidth = 4;
                ctx.moveTo(startPos.x, startPos.y);
                ctx.lineTo(startPos.x + dx * 1.5, startPos.y + dy * 1.5); // ç•«é•·ä¸€é»
                ctx.stroke();
            }

            // 4. çç 
            ctx.save();
            ctx.translate(boba.x, boba.y);
            ctx.rotate(boba.angle); // æ‡‰ç”¨æ—‹è½‰
            
            ctx.beginPath();
            ctx.arc(0, 0, boba.radius, 0, Math.PI * 2);
            ctx.fillStyle = boba.color;
            ctx.fill();
            
            // é«˜å…‰ (è®“çç çœ‹èµ·ä¾†ç«‹é«”)
            ctx.beginPath();
            ctx.arc(-4, -4, 4, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fill();
            
            ctx.restore();

            // 5. æ¯å­å‰å£ (è®“çç çœ‹èµ·ä¾†åœ¨æ¯å­è£¡)
            drawCup(false);
        }

        function drawCup(isBack) {
            const pad = 10;
            const bottomW = cup.width - 20;
            
            if (isBack) {
                // ç•«å¥¶èŒ¶æ¶²é«”
                if (cup.liquidLevel > 0) {
                    ctx.fillStyle = cup.color;
                    const h = cup.liquidLevel;
                    ctx.fillRect(cup.x + 10, cup.y + cup.height - h, cup.width - 20, h);
                }
                
                // åŠé€æ˜æ¯èº«èƒŒæ™¯
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.moveTo(cup.x, cup.y);
                ctx.lineTo(cup.x + 10, cup.y + cup.height);
                ctx.lineTo(cup.x + cup.width - 10, cup.y + cup.height);
                ctx.lineTo(cup.x + cup.width, cup.y);
                ctx.fill();
            } else {
                // æ¯å­è¼ªå»“ç·š (å‰)
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'rgba(200, 200, 200, 0.8)';
                ctx.beginPath();
                // ç•«ä¸€å€‹é¡ä¼¼æ¯å£çš„æ©¢åœ“ç·šæ¢æˆ–æ˜¯å‰ç·£
                ctx.moveTo(cup.x, cup.y);
                ctx.lineTo(cup.x + cup.width, cup.y);
                ctx.stroke();
                
                // æ¯å£å…©å´ç·šæ¢
                ctx.beginPath();
                ctx.moveTo(cup.x, cup.y);
                ctx.lineTo(cup.x + 10, cup.y + cup.height);
                ctx.moveTo(cup.x + cup.width, cup.y);
                ctx.lineTo(cup.x + cup.width - 10, cup.y + cup.height);
                ctx.stroke();
            }
        }

        // åˆå§‹åŒ–èˆ‡ç›£è½è¦–çª—å¤§å°
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡
        loop();

    </script>
</body>

</html>
