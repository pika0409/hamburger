<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êº¢Â†°Á¨®Á¨®Á¨®</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify_content: center;
            align-items: center;
            height: 100vh;
            background-color: #fcefe6;
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }
        h1 {
            color: #5d4037;
            margin: 10px 0;
            font-size: 24px;
            pointer-events: none;
        }
        canvas {
            background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-radius: 12px;
            cursor: grab;
        }
        canvas:active {
            cursor: grabbing;
        }
        #controls {
            margin-top: 10px;
            text-align: center;
            color: #6d4c41;
            font-size: 16px;
            pointer-events: none;
        }
        .highlight {
            color: #d84315;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h1>üßã ÁèçÂ•∂ÂΩàÂ∞ÑÂ§ßÊåëÊà∞ üßã</h1>
<canvas id="gameCanvas"></canvas>
<div id="controls">
    <p>ÊãñÊõ≥ÁèçÁè†ÁûÑÊ∫ñÔºåÊîæÈñãÂ∞ÑÊìäÔºÅ | Ââ©È§ò: <span id="remain-count" class="highlight">5</span></p>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const remainEl = document.getElementById('remain-count');

    // --- 1. Áâ©ÁêÜËàáÈÅäÊà≤ÂèÉÊï∏ ---
    const GRAVITY = 0.6;           
    const BOUNCE = 0.6;            
    const AIR_FRICTION = 0.995;    
    const FLOOR_FRICTION = 0.8;    
    const POWER_MULTIPLIER = 0.15; 

    const COLORS = {
        milkTea: '#D2B48C',
        pearl: '#1E1E1E',
        cupBorder: '#555555',
        text: '#503C3C',
        guideLine: 'rgba(139, 69, 19, 0.5)',
        prediction: 'rgba(210, 105, 30, 0.8)'
    };

    // --- 2. ÈüøÊáâÂºèË¶ñÁ™óË®≠ÂÆö ---
    let bounds = { width: 800, height: 600 };
    let cup = { x: 0, y: 0, w: 0, h: 0 };
    let startPos = { x: 0, y: 0 };

    function resizeCanvas() {
        let w = window.innerWidth * 0.95;
        let h = window.innerHeight * 0.7; 
        
        if (w > 800) w = 800;
        if (h > 600) h = 600;

        canvas.width = w;
        canvas.height = h;
        bounds.width = w;
        bounds.height = h;

        startPos.x = w * 0.15;
        startPos.y = h * 0.75;

        cup.w = w * 0.15;
        if (cup.w < 70) cup.w = 70;
        if (cup.w > 120) cup.w = 120;
        
        cup.h = cup.w * 1.6;
        cup.x = w * 0.75;
        cup.y = h - cup.h - 20;

        if (gameState.currentPearl && !gameState.currentPearl.isFlying && !gameState.currentPearl.isSettled) {
            gameState.currentPearl.x = startPos.x;
            gameState.currentPearl.y = startPos.y;
        }
    }

    // --- 3. ÈÅäÊà≤ÁãÄÊÖã ---
    let gameState = {
        score: 0,
        pearlsLeft: 5,
        isGameOver: false,
        landedPearls: [], 
        currentPearl: null,
        isDragging: false,
        dragInput: { x: 0, y: 0 },
        // Áî®ÊñºÂπ≥ÊªëÊ∂≤Èù¢ÂãïÁï´
        currentLiquidLevel: 0.5, // ÂàùÂßã 50%
        targetLiquidLevel: 0.5
    };

    // --- 4. ÁèçÁè†È°ûÂà• ---
    class Pearl {
        constructor() {
            this.x = startPos.x;
            this.y = startPos.y;
            this.vx = 0;
            this.vy = 0;
            this.radius = 12;
            this.isFlying = false;
            this.isSettled = false; 
            this.rotation = 0;
            this.rotSpeed = 0;
        }

        update() {
            if (!this.isFlying || this.isSettled) return;

            // Áâ©ÁêÜ
            this.vy += GRAVITY;
            this.x += this.vx;
            this.y += this.vy;
            this.rotation += this.rotSpeed;

            this.vx *= AIR_FRICTION;
            this.vy *= AIR_FRICTION;

            // Âú∞ÊùøÁ¢∞Êíû
            if (this.y + this.radius > bounds.height) {
                this.y = bounds.height - this.radius;
                this.vy *= -BOUNCE;
                this.vx *= FLOOR_FRICTION;
                this.rotSpeed = this.vx * 0.1;

                if (Math.abs(this.vy) < 2 && Math.abs(this.vx) < 0.5) {
                    this.settle("miss");
                }
            }
            
            // ÁâÜÂ£ÅÁ¢∞Êíû
            if (this.x + this.radius > bounds.width) {
                this.x = bounds.width - this.radius;
                this.vx *= -BOUNCE;
            } else if (this.x - this.radius < 0) {
                this.x = this.radius;
                this.vx *= -BOUNCE;
            }

            this.checkCupCollision();
        }

        checkCupCollision() {
            // ÈÄ≤ÊùØÂà§ÂÆö
            if (this.vy > 0 && 
                this.x > cup.x + 5 && this.x < cup.x + cup.w - 5 && 
                this.y > cup.y && this.y < cup.y + cup.h / 3) {
                
                this.settle("hit");
                return;
            }

            // ÊíûÂà∞ÊùØÂ£Å
            if (this.y > cup.y + 10) {
                if (this.x + this.radius > cup.x && this.x < cup.x + cup.w / 2) {
                    this.x = cup.x - this.radius;
                    this.vx *= -0.8;
                }
                else if (this.x - this.radius < cup.x + cup.w && this.x > cup.x + cup.w / 2) {
                    this.x = cup.x + cup.w + this.radius;
                    this.vx *= -0.8;
                }
            }
        }

        settle(result) {
            this.isFlying = false;
            this.isSettled = true;

            if (result === "hit") {
                gameState.score++;
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊõ¥Êñ∞ÁõÆÊ®ôÊ∞¥‰ΩçÔºöÂü∫Á§é 50% + (ÂàÜÊï∏ * 10%)
                gameState.targetLiquidLevel = 0.5 + (gameState.score * 0.1);

                // ÊäïÈÄ≤ÔºöÁßªÂãïÂà∞ÊùØÂÖßÈö®Ê©ü‰ΩçÁΩÆ
                const finalX = cup.x + 15 + Math.random() * (cup.w - 30);
                // ËÆìÁèçÁè†Èö®Ê©üÂ†ÜÁñäÂú®ÁõÆÂâçÊ∞¥‰Ωç‰∏ãÂçäÈÉ®
                const finalY = (cup.y + cup.h) - 15 - (Math.random() * (cup.h * 0.6));
                gameState.landedPearls.push({ x: finalX, y: finalY });
            } else {
                // Ê≤íÊäïÈÄ≤ÔºöÁïôÂú®ÂéüÂú∞
                gameState.landedPearls.push({ x: this.x, y: this.y });
            }

            setTimeout(nextTurn, 500);
        }

        draw() {
            if (this.isSettled && !this.isFlying) return; 

            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            
            ctx.beginPath();
            ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = COLORS.pearl;
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(-4, -4, 4, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.fill();
            
            ctx.restore();
        }
    }

    // --- 5. ÊµÅÁ®ãÊéßÂà∂ ---

    function initGame() {
        gameState.score = 0;
        gameState.pearlsLeft = 5;
        gameState.isGameOver = false;
        gameState.landedPearls = [];
        gameState.currentPearl = new Pearl();
        gameState.isDragging = false;
        
        // ÈáçÁΩÆÊ∞¥‰Ωç
        gameState.currentLiquidLevel = 0.5;
        gameState.targetLiquidLevel = 0.5;
        
        remainEl.innerText = gameState.pearlsLeft;
    }

    function nextTurn() {
        gameState.pearlsLeft--;
        remainEl.innerText = gameState.pearlsLeft;
        
        if (gameState.pearlsLeft > 0) {
            gameState.currentPearl = new Pearl();
        } else {
            gameState.currentPearl = null;
            gameState.isGameOver = true;
        }
    }

    // --- 6. ‰∫ã‰ª∂Áõ£ËÅΩ ---

    function getEventPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function handleStart(e) {
        if (gameState.isGameOver || !gameState.currentPearl || gameState.currentPearl.isFlying) return;
        
        const pos = getEventPos(e);
        const dist = Math.hypot(pos.x - gameState.currentPearl.x, pos.y - gameState.currentPearl.y);
        
        if (dist < 60) {
            gameState.isDragging = true;
            gameState.dragInput = pos;
        }
    }

    function handleMove(e) {
        if (gameState.isDragging) {
            gameState.dragInput = getEventPos(e);
        }
    }

    function handleEnd(e) {
        if (gameState.isDragging) {
            gameState.isDragging = false;
            
            const dx = startPos.x - gameState.dragInput.x;
            const dy = startPos.y - gameState.dragInput.y;
            
            if (gameState.currentPearl) {
                gameState.currentPearl.vx = dx * POWER_MULTIPLIER;
                gameState.currentPearl.vy = dy * POWER_MULTIPLIER;
                gameState.currentPearl.isFlying = true;
                gameState.currentPearl.rotSpeed = (Math.random() - 0.5) * 0.5;
            }
        }
    }

    canvas.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);

    canvas.addEventListener('touchstart', handleStart, {passive: false});
    window.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('touchend', handleEnd);

    window.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'r') {
            initGame();
        }
    });

    // --- 7. Áπ™ÂúñËø¥Âúà ---

    function drawLandedPearls() {
        gameState.landedPearls.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 12, 0, Math.PI * 2);
            ctx.fillStyle = COLORS.pearl;
            ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.beginPath(); ctx.arc(p.x-4, p.y-4, 4, 0, Math.PI*2); ctx.fill();
        });
    }

    function drawAimingLine() {
        if (gameState.isDragging && !gameState.currentPearl.isFlying) {
            ctx.beginPath();
            ctx.moveTo(startPos.x, startPos.y);
            ctx.lineTo(gameState.dragInput.x, gameState.dragInput.y);
            ctx.strokeStyle = COLORS.guideLine;
            ctx.lineWidth = 3;
            ctx.setLineDash([8, 6]);
            ctx.stroke();

            const dx = startPos.x - gameState.dragInput.x;
            const dy = startPos.y - gameState.dragInput.y;
            ctx.beginPath();
            ctx.moveTo(startPos.x, startPos.y);
            ctx.lineTo(startPos.x + dx, startPos.y + dy);
            ctx.strokeStyle = COLORS.prediction;
            ctx.lineWidth = 4;
            ctx.setLineDash([]);
            ctx.stroke();
        }
    }

    function loop() {
        // Êõ¥Êñ∞ÈÇèËºØ
        if (gameState.currentPearl) {
            gameState.currentPearl.update();
        }

        // Ê∞¥‰ΩçÂãïÁï´ (ËÆì‰∏äÂçáËÆäÂπ≥Êªë)
        if (gameState.currentLiquidLevel < gameState.targetLiquidLevel) {
            gameState.currentLiquidLevel += 0.005; // ‰∏äÂçáÈÄüÂ∫¶
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // --- Áï´ÊùØÂ≠ê (ÂæåÂ±§ÔºöÂ•∂Ëå∂) ---
        // Ë®àÁÆóÁï∂ÂâçÈ´òÂ∫¶ÂÉèÁ¥†
        const liquidH = cup.h * gameState.currentLiquidLevel;
        
        ctx.fillStyle = COLORS.milkTea;
        ctx.fillRect(cup.x + 5, cup.y + (cup.h - liquidH), cup.w - 10, liquidH);
        
        // Áï´ÁèçÁè†
        drawLandedPearls();

        // Áï´ÊùØÂ≠ê (ÂâçÂ±§ÔºöÊ°ÜÁ∑ö)
        ctx.lineWidth = 4;
        ctx.strokeStyle = COLORS.cupBorder;
        ctx.strokeRect(cup.x, cup.y, cup.w, cup.h);
        ctx.beginPath();
        ctx.moveTo(cup.x, cup.y);
        ctx.lineTo(cup.x + cup.w, cup.y);
        ctx.stroke();

        // ÁôºÂ∞ÑÂè∞
        ctx.beginPath();
        ctx.arc(startPos.x, startPos.y, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#bbb';
        ctx.fill();

        drawAimingLine();

        if (gameState.currentPearl) {
            gameState.currentPearl.draw();
        }

        // UI
        ctx.font = 'bold 30px "Microsoft JhengHei"';
        ctx.fillStyle = COLORS.text;
        ctx.textAlign = 'left';
        ctx.fillText(`ÂæóÂàÜ: ${gameState.score} / 5`, 20, 50);

        // ÁµêÊùüÁï´Èù¢
        if (gameState.isGameOver) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.textAlign = 'center';
            let msg = "", color = "#000";
            
            if (gameState.score === 5) { msg = "ÁèçÁè†‰πãÁ•ûÔºÅÂÆåÁæéÊªøÊùØÔºÅüéâ"; color = "#E64A19"; }
            else if (gameState.score >= 3) { msg = "Â•ΩÂñùÔºÅÂÅöÂæóÂ•ΩÔºÅüòã"; color = "#388E3C"; }
            else { msg = "ÂÜçË©¶‰∏ÄÊ¨°ÂêßÔºÅüí™"; color = "#616161"; }

            ctx.font = 'bold 40px "Microsoft JhengHei"';
            ctx.fillStyle = color;
            ctx.fillText(msg, canvas.width / 2, canvas.height / 2 - 20);

            ctx.font = '24px "Microsoft JhengHei"';
            ctx.fillStyle = "#333";
            ctx.fillText("Êåâ R Êàñ ÈªûÊìäËû¢Âπï ÈáçÊñ∞ÈñãÂßã", canvas.width / 2, canvas.height / 2 + 40);
        }

        requestAnimationFrame(loop);
    }

    canvas.addEventListener('mousedown', (e) => {
        if(gameState.isGameOver) initGame();
    });

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    initGame();
    loop();

</script>
</body>
</html>
